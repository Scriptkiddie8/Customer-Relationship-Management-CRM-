<?php include "header.php"; ?><?phpsession_start();// Check if the user is logged in; if not, redirect to login pageif (!isset($_SESSION['role']) || $_SESSION['role'] != 'Admin') {    header("Location: index.php");    exit();}// Include database connection filerequire_once 'methods/database.php';// Initialize variables$leads = [];$search_phone = "";$search_results = false; // Flag to check if there are search results// Handle searchif ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['search'])) {    $search_phone = trim($_POST["search_phone"]);    $search_results = true; // Set flag to true for search results    $sql = "        SELECT l.id, l.name, l.progress, l.category,l.ad_name, l.created_at, l.note,                COALESCE(lal.assigned_at, 'Not Assigned') as assigned_at        FROM leads l        LEFT JOIN (            SELECT lead_id, MIN(assigned_at) as assigned_at            FROM lead_assignment_logs            GROUP BY lead_id        ) lal ON l.id = lal.lead_id        WHERE l.phone LIKE ?    ";    if ($stmt = mysqli_prepare($link, $sql)) {        $param_phone = '%' . $search_phone . '%';        mysqli_stmt_bind_param($stmt, "s", $param_phone);        mysqli_stmt_execute($stmt);        $result = mysqli_stmt_get_result($stmt);        if ($result) {            while ($row = mysqli_fetch_assoc($result)) {                $leads[] = $row;            }        }        mysqli_stmt_close($stmt);    }} else {    // Fetch all leads if no search    $sql = "    SELECT l.id, l.name, l.progress,l.ad_name ,l.category, l.created_at, l.note,            COALESCE(lal.assigned_at, 'Not Assigned') as assigned_at,           u.first_name AS owner_name    FROM leads l    LEFT JOIN (        SELECT lead_id, MIN(assigned_at) as assigned_at        FROM lead_assignment_logs        GROUP BY lead_id    ) lal ON l.id = lal.lead_id    LEFT JOIN users u ON l.owner = u.id    ORDER BY l.created_at ASC";    if ($stmt = mysqli_prepare($link, $sql)) {        mysqli_stmt_execute($stmt);        $result = mysqli_stmt_get_result($stmt);        if ($result) {            while ($row = mysqli_fetch_assoc($result)) {                $leads[] = $row;            }        }        mysqli_stmt_close($stmt);    }}mysqli_close($link);?><!DOCTYPE html><html lang="en"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Leads Management</title>    <link rel="stylesheet" href="css/adminleads.css">  </head><body>    <div class="leads-container">        <div class="header">            <h2>Leads Management</h2>            <a href="index.php" class="btn-home">Go to Home</a>        </div>        <!-- Search Bar -->        <div class="search-bar">            <form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post">                <input type="text" name="search_phone" placeholder="Search by phone number"                    value="<?php echo htmlspecialchars($search_phone); ?>">                <input type="submit" name="search" value="Search">                <?php if ($search_results): ?>                <a href="adminleads.php" class="btn-back">Back to All Leads</a>                <?php endif; ?>            </form>        </div>        <!-- Tabs -->        <div class="tabs">            <button class="tab-button" onclick="openTab(event, 'tab-all')">All Leads</button>            <?php            $progress_categories = [                'Lost',                'Follow-up',                'Didnt Connect',                'First Call Done',                'Quote Sent',                'Converted',                'Fresh Lead'            ];            // Create tabs for progress categories            foreach ($progress_categories as $index => $category) {                echo '<button class="tab-button" onclick="openTab(event, \'tab-' . $index . '\')">' . htmlspecialchars($category) . '</button>';            }            ?>        </div>        <!-- All Leads Tab -->        <div id="tab-all" class="tab-content">            <table>    <thead>    <tr>        <th>S. No</th> <!-- Serial number column -->        <th>Name</th>        <th>Owner</th>        <th>Progress</th>        <th>ad name</th>        <th>Created At</th>        <th>Assigned At</th>        <th>Note</th>    </tr></thead><tbody>    <?php    $serial_number = 1; // Initialize the serial number    foreach ($leads as $lead) {        // Convert created_at to a timestamp        $createdAt = strtotime($lead['created_at']);        // Convert assigned_at to a timestamp        $assignedAt = strtotime($lead['assigned_at']);        // Get the current time        $currentTime = time();        // Calculate the time difference for 'Created At' in seconds        $timeDiffCreated = $currentTime - $createdAt;        // Calculate the time difference for 'Assigned At' in seconds        $timeDiffAssigned = $currentTime - $assignedAt;        // Determine how to display the time difference for 'Created At'        if ($timeDiffCreated < 3600) { // Less than 1 hour            $timeAgoCreated = floor($timeDiffCreated / 60) . ' minutes ago';        } elseif ($timeDiffCreated < 86400) { // Less than 1 day            $timeAgoCreated = floor($timeDiffCreated / 3600) . ' hours ago';        } else { // 1 day or more            $timeAgoCreated = floor($timeDiffCreated / 86400) . ' days ago';        }        // Determine how to display the time difference for 'Assigned At'        if ($timeDiffAssigned < 3600) { // Less than 1 hour            $timeAgoAssigned = floor($timeDiffAssigned / 60) . ' minutes ago';        } elseif ($timeDiffAssigned < 86400) { // Less than 1 day            $timeAgoAssigned = floor($timeDiffAssigned / 3600) . ' hours ago';        } else { // 1 day or more            $timeAgoAssigned = floor($timeDiffAssigned / 86400) . ' days ago';        }        // Apply red color if the 'Created At' time is older than 6 hours (21600 seconds)        $colorCreated = ($timeDiffCreated > 21600) ? 'red' : 'black';        // Apply red color if the 'Assigned At' time is older than 6 hours (21600 seconds)        $colorAssigned = ($timeDiffAssigned > 21600) ? 'red' : 'black';        $progress_class = strtolower(str_replace(' ', '-', $lead['progress']));        echo '<tr class="clickable-row progress-' . $progress_class . '" onclick="window.location.href=\'lead_action.php?id=' . htmlspecialchars($lead['id']) . '\'">';        echo '<td>' . $serial_number++ . '</td>'; // Display the serial number        echo '<td>' . htmlspecialchars($lead['name']) . '</td>';        echo '<td>' . htmlspecialchars($lead['owner_name']) . '</td>'; // Display the owner name        echo '<td>' . htmlspecialchars($lead['progress']) . '</td>';        echo '<td>' . htmlspecialchars($lead['ad_name']) . '</td>';        echo '<td><span style="color: '. $colorCreated . ';">' .  $lead['created_at'] . '</span></td>';        echo '<td>' .  $lead['assigned_at'] . '</td>';        echo '<td class="note-cell">' . htmlspecialchars($lead['note']) . '</td>';        echo '</tr>';    }    ?></tbody></table></div><!-- Other Tabs for Progress Categories --><?phpforeach ($progress_categories as $index => $category) {    echo '<div id="tab-' . $index . '" class="tab-content">';    echo '<table>';    echo '<thead>';    echo '<tr>';    echo '<th>Name</th>';    echo '<th>Progress</th>';    echo '<th>Category</th>';    echo '<th>Created At</th>';    echo '<th>Assigned At</th>';    echo '<th>Note</th>';    echo '</tr>';    echo '</thead>';    echo '<tbody>';        foreach ($leads as $lead) {            if ($lead['progress'] == $category) {                $createdAt = strtotime($lead['created_at']);                $assignedAt = strtotime($lead['assigned_at']);                $currentTime = time();                $timeDiffCreated = $currentTime - $createdAt;                        // Check if $assignedAt is null                if ($assignedAt === false) { // strtotime returns false if the date is invalid                    $timeDiffAssigned = 'not assigned';                    $timeAgoAssigned = 'not assigned';                    $colorAssigned = 'black'; // Or any default color you prefer                } else {                    $timeDiffAssigned = $currentTime - $assignedAt;                            if ($timeDiffAssigned < 3600) { // Less than 1 hour                        $timeAgoAssigned = floor($timeDiffAssigned / 60) . ' minutes ago';                    } elseif ($timeDiffAssigned < 86400) { // Less than 1 day                        $timeAgoAssigned = floor($timeDiffAssigned / 3600) . ' hours ago';                    } else { // 1 day or more                        $timeAgoAssigned = floor($timeDiffAssigned / 86400) . ' days ago';                    }                            $colorAssigned = ($timeDiffAssigned > 21600) ? 'red' : 'black';                }                        if ($timeDiffCreated < 3600) { // Less than 1 hour                    $timeAgoCreated = floor($timeDiffCreated / 60) . ' minutes ago';                } elseif ($timeDiffCreated < 86400) { // Less than 1 day                    $timeAgoCreated = floor($timeDiffCreated / 3600) . ' hours ago';                } else { // 1 day or more                    $timeAgoCreated = floor($timeDiffCreated / 86400) . ' days ago';                }                        $colorCreated = ($timeDiffCreated > 21600) ? 'red' : 'black';                $progress_class = strtolower(str_replace(' ', '-', $lead['progress']));                        echo '<tr class="clickable-row progress-' . $progress_class . '" onclick="window.location.href=\'lead_action.php?id=' . htmlspecialchars($lead['id']) . '\'">';                echo '<td>' . htmlspecialchars($lead['name']) . '</td>';                echo '<td>' . htmlspecialchars($lead['progress']) . '</td>';                echo '<td>' . htmlspecialchars($lead['category']) . '</td>';                echo '<td>' . $timeAgoCreated . '</td>';                echo '<td>' . $timeAgoAssigned . '</td>'; // Output the formatted time difference or 'not assigned'                echo '<td class="note-cell">' . htmlspecialchars($lead['note']) . '</td>';                echo '</tr>';            }        }    echo '</tbody>';    echo '</table>';    echo '</div>';}?>    </div>    <script>    function openTab(evt, tabName) {        var i, tabcontent, tablinks;        tabcontent = document.getElementsByClassName("tab-content");        for (i = 0; i < tabcontent.length; i++) {            tabcontent[i].style.display = "none";        }        tablinks = document.getElementsByClassName("tab-button");        for (i = 0; i < tablinks.length; i++) {            tablinks[i].className = tablinks[i].className.replace(" active", "");        }        document.getElementById(tabName).style.display = "block";        evt.currentTarget.className += " active";    }    // Default open tab    document.addEventListener("DOMContentLoaded", function() {        document.querySelector(".tab-button").click();    });    </script></body></html>